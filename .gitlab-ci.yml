---
variables:
  # override these by CI variables
  # set to empty in order to disable FIPS
  ENABLE_FIPS: '--insert --order 0 --how feature --fips enabled'
  TFCLI_TMT_PREPARE: $ENABLE_FIPS
  # e.g. 'name:.*linters\|.*tier0'
  TFCLI_PLAN_FILTER:
  # e.g. to skip python_tier1_tests: 'name:(?!.*python_tier1_tests).*'
  TFCLI_TEST_FILTER:


.parallel:
  parallel:
    matrix:
      - BASE_IMAGE_NAME: [
        # "PcsFedoraCurrentRelease",
        "PcsRhel10Next",
        # "PcsRhelCurrentRelease",
      ]
        OS_TAG: "shared-podman"
  tags:
    - ${OS_TAG}

stages:
  - stage1

.download_artifacts_from_tf: &download_artifacts_from_tf
  - UUID_REGEX="[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}"
  - REQUEST_ID=$(sed -n -E "s/.*($UUID_REGEX).*/\1/p" output.txt | head -n 1)
  - echo "Testing Farm request id is $REQUEST_ID"
  - EXIT_CODE=0
  - testing-farm watch --id $REQUEST_ID || EXIT_CODE=$?
  - >
    curl --insecure --location --remote-name \
      "https://artifacts.osci.redhat.com/testing-farm/$REQUEST_ID/results.xml"
  - >
    for ARTIFACT_DIR in rpms dist; do
      for ARTIFACT_URL in $(
        xmllint \
          --xpath "//log[starts-with(@name, 'data/$ARTIFACT_DIR')]/@href" \
          results.xml \
        | sed "s/.*=\"\(.*\)\"/\1/"
      ); do
        echo $ARTIFACT_URL >&2;
        curl --insecure --remote-name --create-dirs \
          --output-dir "$ARTIFACT_DIR" "$ARTIFACT_URL";
      done
    done
  - exit $EXIT_CODE

testing_farm_tmt_tests:
  extends: .parallel
  stage: stage1
  image: $SHARED_RUNNER_CONTAINER_IMAGE
  script:
    - testing-farm request
      --git-url
      https://gitlab-ci-token:$CI_JOB_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH
      --git-ref $CI_COMMIT_REF_NAME
      --compose $(eval echo \$$BASE_IMAGE_NAME)
      --context distro=$(eval echo \$${BASE_IMAGE_NAME}_distro)
      --environment BASE_IMAGE_NAME=$BASE_IMAGE_NAME
      --plan-filter "$TFCLI_PLAN_FILTER"
      --test-filter "$TFCLI_TEST_FILTER"
      --tmt-prepare "$TFCLI_TMT_PREPARE"
      --no-wait
      | tee output.txt
    - *download_artifacts_from_tf
  artifacts:
    expire_in: 1 week
    paths:
      - rpms
      - dist

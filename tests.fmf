# https://tmt.readthedocs.io/en/stable/spec/tests.html
component: pcs
duration: 30m
path: /
environment:
  CONFIGURE_OPTIONS_LINTERS: >-
    --enable-local-build
    --enable-individual-bundling
    --enable-dev-tests
    --enable-tests-only
    --enable-typos-check
  CONFIGURE_OPTIONS_TIER0: >-
    --enable-local-build
    --enable-individual-bundling
  CONFIGURE_OPTIONS_DISTCHECK_RPMBUILD: >-
    --enable-local-build
    --enable-individual-bundling
    --enable-webui
  CONFIGURE_OPTIONS_TIER1: >-
    --enable-local-build
    --enable-individual-bundling
    --enable-webui
    --enable-destructive-tests
    --enable-tests-only
adjust:
  - environment+:
    CONFIGURE_OPTIONS_DISTCHECK_RPMBUILD: >-
      --enable-local-build
    when: distro == rhel-9


/autotools_linters:
  summary: Run autotools to prepare pcs source code
  tag: [autotools, lint]
  test: |
    ./autogen.sh &&
    ./configure $CONFIGURE_OPTIONS_LINTERS &&
    make

/ruff_lint:
  summary: Run ruff linter
  tag: [lint]
  test: make ruff_lint


/ruff_format_check:
  summary: Run ruff format check
  tag: [lint]
  test: make ruff_format_check

/mypy:
  summary: Run mypy type checking
  tag: [lint]
  test: make mypy

/typos:
  summary: Run typos check
  tag: [lint]
  test: make typos_check

/autotools_tier0:
  summary: Run autotools to prepare pcs source code
  tag: [autotools, tier0]
  test: |
    ./autogen.sh &&
    ./configure $CONFIGURE_OPTIONS_TIER0 &&
    make

/python_tier0_tests:
  summary: Run python tier0 tests
  tag: [tier0, python]
  test: make tests_tier0

/ruby_tests:
  summary: Run ruby tier0 tests
  tag: [tier0, ruby]
  test: make pcsd-tests


/autotools_archive:
  summary: Run autotools to prepare pcs source code for distcheck and rpm_build
  tag: [autotools, distcheck, rpm_build]
  test: |
    ./autogen.sh &&
    ./configure $CONFIGURE_OPTIONS_DISTCHECK_RPMBUILD


/distcheck:
  summary: Run make distcheck
  tag: [distcheck]
  test: |
    make distcheck DISTCHECK_CONFIGURE_FLAGS="$CONFIGURE_OPTIONS_DISTCHECK_RPMBUILD" &&
    rename --verbose .tar. ".${BASE_IMAGE_NAME}.tar." pcs*.tar.* &&
    mkdir -p dist &&
    cp -v pcs*.tar.* dist/ &&
    cp -rv dist $TMT_PLAN_DATA && ls -ld $TMT_PLAN_DATA &&
    cp -rv dist $TMT_TEST_DATA && ls -ld $TMT_TEST_DATA

/rpm_build:
  summary: Run make rpm to build a pcs package
  tag: [rpm_build]
  test: |
    make CI_BRANCH=${BASE_IMAGE_NAME} rpm/pcs.spec &&
    dnf builddep -y --enablerepo='rhel-buildroot' rpm/pcs.spec &&
    make CI_BRANCH=${BASE_IMAGE_NAME} rpm &&
    mkdir -p rpms &&
    cp -v $(find rpm  -type f -name '*.rpm' -not -name '*.src.rpm') rpms &&
    cp -rv rpms $TMT_PLAN_DATA && ls -ld $TMT_PLAN_DATA &&
    cp -rv rpms $TMT_TEST_DATA && ls -ld $TMT_TEST_DATA

/autotools_tier1:
  summary: Run autotools to prepare pcs source code for tier1 tests
  tag: [autotools, tier1]
  test: |
    ./autogen.sh &&
    ./configure $CONFIGURE_OPTIONS_TIER1 &&
    make

/python_tier1_tests:
  summary: Run pcs python tier1 tests
  tag: [tier1]
  duration: 1h
  test: |
    dnf install -y $TMT_PLAN_DATA/rpms/pcs-*${BASE_IMAGE_NAME}*$(rpm -E %{dist}).*.rpm &&
    rm -rf pcs pcsd pcs_bundled &&
    pcs_test/suite -v --installed --tier1

/python_smoke_tests:
  summary: Run pcs smoke tests
  tag: [smoke]
  test: |
    dnf install -y $TMT_PLAN_DATA/rpms/pcs-*${BASE_IMAGE_NAME}*$(rpm -E %{dist}).*.rpm &&
    systemctl start pcsd &&
    sleep 2 &&
    rm -rf pcs &&
    pcs_test/smoke.sh

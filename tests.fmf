# https://tmt.readthedocs.io/en/stable/spec/tests.html
component: pcs
duration: 30m
path: /
environment:
  CONFIGURE_OPTIONS: >-
      --enable-local-build
      --enable-individual-bundling
      --enable-dev-tests
      --enable-webui
      --enable-destructive-tests
  CONFIGURE_OPTIONS_DISTCHECK: >-
      --enable-local-build
      --enable-individual-bundling

/autotools:
  summary: Build pcs to run tests
  tag: [
    autotools, distcheck, lint, python, rpm_build, ruby, smoke, tier0, tier1,
  ]
  test: |
    ./autogen.sh &&
    ./configure $CONFIGURE_OPTIONS &&
    make

/ruff_lint:
  summary: Run ruff linter
  tag: [lint]
  test: make ruff_lint

/ruff_format_check:
  summary: Run ruff format check
  tag: [lint]
  test: make ruff_format_check

/mypy:
  summary: Run mypy type checking
  tag: [lint]
  test: make mypy

/typos:
  summary: Run typos check
  tag: [lint]
  test: make typos_check

/python_tier0_tests:
  summary: Run python tier0 tests
  tag: [tier0, python]
  test: make tests_tier0

/ruby_tests:
  summary: Run ruby tier0 tests
  tag: [tier0, ruby]
  test: make pcsd-tests

/distcheck:
  summary: Run make distcheck
  tag: [distcheck]
  test: |
    make distcheck DISTCHECK_CONFIGURE_FLAGS="$CONFIGURE_OPTIONS_DISTCHECK" &&
    rename --verbose .tar. ".${COMPOSE_ALIAS}.tar." pcs*.tar.* &&
    mkdir -p dist &&
    cp -v pcs*.tar.* dist/ &&
    cp -rv dist $TMT_PLAN_DATA &&
    cp -rv dist $TMT_TEST_DATA

/rpm_build:
  summary: Run make rpm to build a pcs package
  tag: [rpm_build, smoke, tier1]
  test: |
    make CI_BRANCH=${COMPOSE_ALIAS} rpm/pcs.spec &&
    dnf builddep -y rpm/pcs.spec &&
    make CI_BRANCH=${COMPOSE_ALIAS} rpm &&
    mkdir -p rpms &&
    cp -v $(find rpm  -type f -name '*.rpm' -not -name '*.src.rpm') rpms &&
    cp -rv rpms $TMT_PLAN_DATA &&
    cp -rv rpms $TMT_TEST_DATA

/python_tier1_tests:
  summary: Install pcs rpm and run pcs python tier1 tests
  tag: [tier1]
  duration: 1h
  # installing built pcs.rpm installs pacemaker, corosync, etc. as dependencies
  # rm -rf pcs - to make sure we are testing installed packages and not sources
  test: |
    dnf install -y \
      $TMT_PLAN_DATA/rpms/pcs-*${COMPOSE_ALIAS}*$(rpm -E %{dist}).*.rpm &&
    rm -rf pcs pcsd pcs_bundled &&
    pcs_test/suite -v --installed --tier1

/python_smoke_tests:
  summary: Install pcs rpm and run pcs smoke tests
  tag: [smoke]
   # installing built pcs.rpm installs pacemaker, corosync, etc. as dependencies
   # rm -rf pcs - to make sure we are testing installed packages and not sources
  test: |
    dnf install -y \
      $TMT_PLAN_DATA/rpms/pcs-*${COMPOSE_ALIAS}*$(rpm -E %{dist}).*.rpm &&
    rm -rf pcs pcsd pcs_bundled &&
    systemctl start pcsd &&
    sleep 2 &&
    pcs_test/smoke.sh &&
    mkdir -p {$TMT_PLAN_DATA,$TMT_TEST_DATA}/var/log/ &&
    cp -rv /var/log/pcsd $TMT_PLAN_DATA/var/log &&
    cp -rv /var/log/pcsd $TMT_TEST_DATA/var/log
